<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ø¨Ø§Ø²ÛŒ Ù¾Ù†Ù„ - iSwitch</title>
  <style>
    /* =========================================
       ÙÙˆÙ†Øª Ù‡Ø§ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§
       ========================================= */
    @font-face {
      font-family: 'Digital7';
      src: url('assets/digital-7.ttf') format('truetype'); /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯ ÙØ§ÛŒÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯ ÛŒØ§ ÙÙˆÙ†Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù„ÙˆØ¯ Ø´ÙˆØ¯ */
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --bg: #071025;
      --panel-w: 1808px;
      --panel-h: 592px;
      --led-size: 50px;
      --accent: #00ff9d;
      --error-color: #fa0536;
    }

    * {
      box-sizing: border-box;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(180deg, #051020, #071025 40%);
      font-family: "Vazirmatn", "Tahoma", sans-serif;
      color: #e6eef6;
      overflow: hidden; 
    }

    /* =========================================
       ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ù…ØªØ­Ø±Ú©
       ========================================= */
    #loadingScreen {
      position: fixed;
      inset: 0;
      background: #051020;
      z-index: 999999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.6s ease, visibility 0.6s;
    }

    .loader-ring {
      width: 80px;
      height: 80px;
      border: 4px solid rgba(0, 255, 157, 0.1);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spinLoader 1s linear infinite;
      box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
    }

    .loader-text {
      margin-top: 20px;
      font-family: 'Digital7', monospace;
      font-size: 28px;
      color: var(--accent);
      letter-spacing: 3px;
      animation: pulseText 1.5s ease-in-out infinite alternate;
    }

    @keyframes spinLoader { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulseText { 0% { opacity: 0.5; text-shadow: 0 0 5px var(--accent); } 100% { opacity: 1; text-shadow: 0 0 15px var(--accent); } }

    /* =========================================
       ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
       ========================================= */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #071025, #0a192f);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease;
    }
    
    .login-box {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      text-align: center;
    }

    .login-box h2 {
      margin-top: 0;
      color: var(--accent);
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(0,255,157,0.3);
    }

    .input-group { margin-bottom: 15px; text-align: right; }
    .input-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #a8c0d8; }
    .input-group input {
      width: 100%; padding: 12px; border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3); color: #fff;
      font-family: inherit; outline: none; transition: border-color 0.3s;
    }
    .input-group input:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(0,255,157,0.2); }

    .start-btn {
      width: 100%; padding: 12px; background: var(--accent); color: #042018;
      border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
      cursor: pointer; margin-top: 15px; transition: transform 0.2s, box-shadow 0.2s;
    }
    .start-btn:active { transform: scale(0.98); }
    .error-msg { color: #ffbbb7; font-size: 12px; margin-top: 5px; display: none; }

    /* =========================================
       Ù…Ø­ÛŒØ· Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ
       ========================================= */
    .game-viewport {
      width: 100vw;
      height: 100vh;
      overflow: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…Ø±ÙˆØ±Ú¯Ø± */
      display: none; 
      align-items: center;
      justify-content: center;
      background: #000;
    }

    /* Container Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø²ÙˆÙ… Ùˆ Ù¾Ù† */
    .zoom-container {
        overflow: hidden; 
        touch-action: none; 
        position: relative;
        cursor: grab;
        width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
    }
    .zoom-container:active { cursor: grabbing; }

    .panel-wrap {
      position: absolute; /* ØªØºÛŒÛŒØ± Ø¨Ù‡ absolute Ø¨Ø±Ø§ÛŒ Ù‡Ù†Ø¯Ù„ Ø¨Ù‡ØªØ± ØªØ±Ù†Ø³ÙØ±Ù… */
      width: var(--panel-w);
      height: var(--panel-h);
      flex-shrink: 0; 
      background: transparent;
      transform-origin: center center;
    }

    .panel-bg {
      width: 100%; height: 100%; display: block; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;
    }

    .mushroom, .push-btn, .selector, .joystick, .fan-wrap, 
    .led, .protector-area, .game-timer, .stages, 
    .map-small, .error-badge, .win-light {
      position: absolute; z-index: 2;
    }

    /* LED Ù‡Ø§ */
    .led {
      width: var(--led-size); height: var(--led-size); border-radius: 50%;
      box-shadow: 0 0 0 rgba(0,0,0,0.0); opacity: 0.35; transition: all .18s ease; pointer-events: none;
    }
    .led-red { background: radial-gradient(circle at 30% 30%, #f72c2c, #ff0000); left: 1274px; top: 138px; z-index: 3; }
    .led-yellow { background: radial-gradient(circle at 30% 30%, #ffd93d, #ff9f00); left:1274px; top: 45px; z-index: 2; }
    .led-green { background: radial-gradient(circle at 30% 30%, #6bff6b, #00ff00); left: 1274px; top: 138px; z-index: 3; }
    .led[data-state="on"] { opacity: 1; filter: drop-shadow(0 0 15px currentColor) brightness(1.3); }

    /* Ù¾ÙˆØ´ Ø¨Ø§ØªÙ† Ù‡Ø§ */
    .push-btn {
      width: 45px; height: 45px; border-radius: 50%; border: none;
      background: transparent; color: rgba(255,255,255,0.7); font-weight: 700;
      font-size: 11px; cursor: pointer; transition: transform .06s ease;
      box-shadow: none;
    }
    #S1 {left: 1448px; top: 142px; }
    #S4_START { left: 1056px; top: 186px; }
    #S4_STOP { left: 1056px; top: 240px; }
    #S6_START { left: 1170px; top: 164px; }
    #S6_STOP { left: 1170px; top: 240px; }
    #S7 { left: 1626px;top: 357.3px; }
    #S8 { left: 1626px;top: 238.3px; }
    #S10 { left: 1626px;top: 140px;}

    .push-btn[aria-pressed="true"] { transform: translateY(6px); }

    /* Ø³Ù„Ú©ØªÙˆØ±Ù‡Ø§ */
    .selector {
      width: 48px; height: 28px; border-radius: 6px; background: rgba(0,0,0,0.5);
      color: #fff; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform .08s ease; user-select: none;
    }
    .selector[data-pos="left"] { transform: rotate(310deg); }
    .selector[data-pos="right"] { transform: rotate(18deg); }
    #S2 { left: 1450px; top: 241.3px; }
    #S3 { left: 1274px; top: 244px; }
    #S5 { left: 1450px; top: 366px; }

    /* Ø¬ÙˆÛŒ Ø§Ø³ØªÛŒÚ© */
    .joystick {
      left: 1666px; top: 34px; width: 30px; height: 30px; border-radius: 50%;
      background: #111827; border: none; color: #fff; cursor: pointer; transition: transform .12s ease;
    }
    .joystick[data-pos="down"] { transform: translateY(10px) rotate(6deg); }

    /* Ù…Ø­Ø§ÙØ¸ */
    .protector-area {
        left: 23.3%; top: 45.4%; width: 60px; height: 60px; cursor: pointer;
        display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.7); border-radius: 8px;
    }
    .protector-display { font-family: 'Digital7', monospace; font-size: 28px; color: #ff3b30; text-shadow: 0 0 10px rgba(255, 59, 48, 0.5); }

    /* ÙÙ† Ù‡Ø§ */
    .fan-wrap { width: 175px; height: 175px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
    .fan-base { position: absolute; width: 100%; height: 100%; object-fit: contain;}
    .fan-blade { position: absolute; width: 70%; height: 70%; object-fit: contain; transform-origin: center center; transition: opacity .16s ease; opacity: 0; }
    #fanBlue { left: 52%; top: 59.7%; }
    #fanYellow { left: 66.1%; top: 59.7%; }
    
    .rotate-medium { animation: fanSpin 0.7s linear infinite; opacity: 1; }
    @keyframes fanSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Ø¯Ú©Ù…Ù‡ Ù‚Ø§Ø±Ú†ÛŒ */
    .mushroom { width: 50px; height: 50px; left: 1450px; top: 40px; background: transparent; border: none; cursor: pointer; border-radius: 26px; }

    /* ØªÛŒÚ© Ù…Ø±Ø§Ø­Ù„ */
    .stages { right:70%; top: 5%; display: flex; gap: 8px; }
    .stage {
      width: 26px; height: 26px; border-radius: 6px; background: rgba(255,255,255,0.06);
      display: flex; align-items: center; justify-content: center; font-weight: 700; color: #a8c0d8; font-size: 13px;
    }
    .stage.done { background: linear-gradient(90deg, #34d399, #10b981); color: #042018; box-shadow: 0 6px 16px rgba(16,185,129,0.12); }

    /* ØªØ§ÛŒÙ…Ø± Ùˆ Ù†Ù‚Ø´Ù‡ */
    .game-timer { left: 5%; top: 5%; background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 8px; font-family: 'Digital7', monospace; font-size: 22px; color: #ffd166; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .map-small {
      left: 5%; bottom: 5%; width: 80px; height: 60px; border-radius: 6px; cursor: pointer;
      border: 2px solid rgba(255,255,255,0.1); overflow: hidden; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); color: white; font-size: 12px; z-index: 10;
    }
    .map-thumbnail { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

    /* Ù‡Ø´Ø¯Ø§Ø± */
    .error-badge {
      right: 5%; bottom: 5%; background: var(--error-color); color: #fff; width: 30px; height: 30px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; opacity: 0; transform: translateY(8px); transition: all .28s ease;
    }
    .error-badge.show { opacity: 1; transform: translateY(0); }

    /* Ú†Ø±Ø§Øº Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù† (Ø³Ø¨Ø² Ø±Ù†Ú¯) */
    .win-light {
      left: 50%; top: 5%; width: 400px; height: 120px; border-radius: 8px;
      background: transparent; border: 3px solid rgba(255,255,255,0.1); box-shadow: none; transition: all .3s ease; transform: translateX(-50%); pointer-events: none;
    }
    .win-light.on { 
      background: transparent;
      border: 3px solid var(--accent); /* Ø³Ø¨Ø² */
      box-shadow: 0 0 20px rgba(0,255,157,0.8), 0 0 40px rgba(0,255,157,0.4), inset 0 0 15px rgba(0,255,157,0.3);
      animation: pulseGreen 1.5s ease-in-out infinite alternate;
    }
    @keyframes pulseGreen {
      from { box-shadow: 0 0 15px rgba(0,255,157,0.6), 0 0 30px rgba(0,255,157,0.3), inset 0 0 10px rgba(0,255,157,0.2); }
      to { box-shadow: 0 0 25px rgba(0,255,157,1), 0 0 50px rgba(0,255,157,0.6), inset 0 0 20px rgba(0,255,157,0.4); }
    }

    /* =========================================
       Ù…ÙˆØ¯Ø§Ù„ Ù‡Ø§
       ========================================= */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal.open { display: flex; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.7); }
    .modal-box { position: relative; z-index: 60; background: #0b1220; padding: 18px; border-radius: 12px; min-width: 260px; color: #fff; box-shadow: 0 18px 50px rgba(0,0,0,0.6); transform: scale(.8); transition: transform .28s ease; }
    .modal.open .modal-box { transform: scale(1); }

    /* Ù…ÙˆØ¯Ø§Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ† */
    .rules-content {
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        text-align: right;
        direction: rtl;
        line-height: 1.8;
    }
    .rules-text h3 {
        color: #4CAF50;
        margin-top: 15px;
        border-bottom: 1px solid #555;
        padding-bottom: 5px;
        font-size: 16px;
    }
    .rules-text ul { list-style-type: disc; padding-right: 20px; margin-top: 5px; }
    #agree-rules-btn {
        width: 100%; margin-top: 20px; background-color: #4CAF50; font-size: 16px; padding: 12px; border:none; border-radius: 8px; color: #fff; cursor: pointer; font-weight: bold;
    }
    #agree-rules-btn:hover { background-color: #45a049; }
    
    /* Ø­Ø°Ù Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ø§Ø² Ù…ÙˆØ¯Ø§Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ† */
    #rules-modal .close-btn { display: none; }

    /* Ù…ÙˆØ¯Ø§Ù„ Ù…Ø­Ø§ÙØ¸ */
    .protector-ui { display: flex; flex-direction: column; gap: 12px; align-items: center; }
    .protector-title { font-size: 20px; font-weight: 900; color: #9fd5ff; }
    .protector-value { font-family: 'Digital7'; font-size: 38px; background: #000; padding: 6px 12px; border-radius: 8px; color: #00ff80; transition: all 0.1s ease; }
    .protector-value.changing { color: #ffd166; transform: scale(1.05); }
    .protector-controls { display: flex; gap: 8px; }
    .ctrl { padding: 8px 12px; border-radius: 8px; border: none; background: #111827; color: #fff; cursor: pointer; font-weight: 700; transition: all 0.1s ease; }
    .ctrl:active { background: #1e40af !important; transform: scale(0.95); }
    .prot-close { cursor: pointer; color: #9fb1c9; font-size: 13px; margin-top:10px;}

    /* Ù…ÙˆØ¯Ø§Ù„ Ù†Ù‚Ø´Ù‡ */
    .map-modal .modal-box { 
        max-width: 95vw; max-height: 95vh; width: 95vw; height: 95vh;
        padding: 0; background: transparent; 
        box-shadow: 0 25px 80px rgba(0,0,0,0.9); 
        border: 3px solid rgba(255,255,255,0.1); border-radius: 12px; 
        overflow: hidden; display: flex; align-items: center; justify-content: center;
    }
    .map-large { width: 100%; height: 100%; object-fit: contain; display: block; transform-origin: center center; }
    .map-close { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 70; display: flex; align-items: center; justify-content: center; }
    
    /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø³Ø§Ø¯Ù‡ */
    @media (orientation: portrait) {
      .game-viewport { align-items: center; justify-content: center; }
    }
  </style>
</head>
<body>

  <!-- ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
  <div id="loadingScreen">
    <div class="loader-ring"></div>
    <div class="loader-text">LOADING...</div>
  </div>

  <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†</h2>
      <form id="loginForm">
        <div class="input-group">
          <label>Ù†Ø§Ù…</label>
          <input type="text" id="fname" required placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        <div class="input-group">
          <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
          <input type="text" id="lname" required placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        <div class="input-group">
          <label>Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
          <input type="tel" id="phone" required placeholder="09123456789" maxlength="11" dir="ltr">
          <div class="error-msg" id="phoneError">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Û±Û± Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯ Ùˆ Ø¨Ø§ Û°Û¹ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯.</div>
        </div>
        
        <button type="submit" class="start-btn" id="startBtn">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
      </form>
    </div>
  </div>

  <!-- Ù…Ø­ÛŒØ· Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ -->
  <main class="game-viewport" id="gameViewport">
    <!-- Container Ø¨Ø±Ø§ÛŒ Ø²ÙˆÙ… -->
    <div id="gameZoomContainer" class="zoom-container">
        <!-- panel-wrap Ø§Ù„Ù…Ø§Ù†ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø²ÙˆÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
        <div class="panel-wrap" id="gamePanel">
        <img src="assets/BOARD.png" alt="Ù¾Ù†Ù„" class="panel-bg" id="panelBg">

        <!-- LED Ù‡Ø§ -->
        <div class="led led-red" id="LED3" data-state="off"></div>
        <div class="led led-yellow" id="LED4" data-state="off"></div>
        <div class="led led-green" id="LED1" data-state="off"></div>
        
        <!-- Ù¾ÙˆØ´ Ø¨Ø§ØªÙ† Ù‡Ø§ -->
        <button id="S0" class="mushroom">S0</button>
        <button class="push-btn" id="S1" data-id="S1" aria-pressed="false">S1</button>
        <button class="push-btn" id="S4_START" data-id="S4_START" aria-pressed="false">S4 Start</button>
        <button class="push-btn" id="S6_START" data-id="S6_START" aria-pressed="false">S6 Start</button>
        <button class="push-btn" id="S4_STOP" data-id="S4_STOP" aria-pressed="false">S4 Stop</button>
        <button class="push-btn" id="S6_STOP" data-id="S6_STOP" aria-pressed="false">S6 Stop</button>
        <button class="push-btn" id="S7" data-id="S7" aria-pressed="false">S7</button>
        <button class="push-btn" id="S8" data-id="S8" aria-pressed="false">S8</button>
        <button class="push-btn" id="S10" data-id="S10" aria-pressed="false">S10</button>

        <!-- Ø³Ù„Ú©ØªÙˆØ±Ù‡Ø§ -->
        <div class="selector" id="S2" data-pos="left" role="switch">S2</div>
        <div class="selector" id="S3" data-pos="left" role="switch">S3</div>
        <div class="selector" id="S5" data-pos="left" role="switch">S5</div>

        <!-- Ø¬ÙˆÛŒâ€ŒØ§Ø³ØªÛŒÚ© -->
        <button class="joystick" id="S9" data-pos="neutral">S9</button>

        <!-- Ù…Ø­Ø§ÙØ¸ -->
        <div id="protectorArea" class="protector-area">
            <div class="protector-display" id="protectorDisplay">300</div>
        </div>

        <!-- ÙÙ† Ù‡Ø§ -->
        <div class="fan-wrap fan-blue" id="fanBlue">
            <div class="fan-base" style="background: radial-gradient(circle at 30% 30%, #3b82f6, #1e40af); border-radius: 50%;"></div>
            <div class="fan-blade" id="fanBladeBlue" style="background: conic-gradient(#60a5fa, #93c5fd, #60a5fa); border-radius: 50%;"></div>
        </div>

        <div class="fan-wrap fan-yellow" id="fanYellow">
            <div class="fan-base" style="background: radial-gradient(circle at 30% 30%, #f59e0b, #d97706); border-radius: 50%;"></div>
            <div class="fan-blade" id="fanBladeYellow" style="background: conic-gradient(#fbbf24, #fcd34d, #fbbf24); border-radius: 50%;"></div>
        </div>

        <!-- ØªÛŒÚ© Ù…Ø±Ø§Ø­Ù„ -->
        <div class="stages" id="stages">
            <div class="stage" data-stage="1">1</div>
            <div class="stage" data-stage="2">2</div>
            <div class="stage" data-stage="3">3</div>
            <div class="stage" data-stage="4">4</div>
            <div class="stage" data-stage="5">5</div>
            <div class="stage" data-stage="6">6</div>
            <div class="stage" data-stage="7">7</div>
        </div>

        <!-- ØªØ§ÛŒÙ…Ø± Ùˆ Ù†Ù‚Ø´Ù‡ -->
        <div class="game-timer" id="gameTimer">03:00</div>
        <div id="mapSmall" class="map-small">
            <img src="assets/map_small.png" alt="Ù†Ù‚Ø´Ù‡" class="map-thumbnail" onerror="this.style.display='none'; this.parentNode.innerHTML='Ù†Ù‚Ø´Ù‡';">
        </div>

        <!-- Ø®Ø·Ø§ Ùˆ Ú©Ø§Ø¯Ø± Ù¾ÛŒØ±ÙˆØ²ÛŒ -->
        <div class="error-badge" id="errorBadge">âœ–</div>
        <div class="win-light" id="winLight"></div>
        </div>
    </div>
  </main>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ† -->
  <div id="rules-modal" class="modal">
    <div class="modal-box">
      <div class="modal-content rules-content">
          <!-- Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª ØªØ§ Ú©Ø§Ø±Ø¨Ø± Ù…Ø¬Ø¨ÙˆØ± Ø¨Ù‡ ØªØ§ÛŒÛŒØ¯ Ø´ÙˆØ¯ -->
          <h2>Ø´Ø±Ø§ÛŒØ· Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¨Ø§Ø²ÛŒ iSwitch</h2>
          <div class="rules-text">
              <p style="color: #ffeb3b; font-weight: bold; background: #333; padding: 10px; border-radius: 5px; text-align: center;">
                  ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ù‡Ù…: Ø¨Ø±Ø§ÛŒ Ø³Ù‡ÙˆÙ„Øª Ùˆ ØªØ³Ù„Ø· Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ú¯ÙˆØ´ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ØŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ú†Ø±Ø®Ø§Ù†ÛŒØ¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÙÙ‚ÛŒ (Landscape) Ø¨Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.
              </p>
              
              <h3>Û±. Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ø´Ø±Ø§ÛŒØ·</h3>
              <ul>
                  <li><strong>ÛŒÚ©â€ŒØ¨Ø§Ø± ÙØ±ØµØª:</strong> Ù‡Ø± Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ ØªÙ†Ù‡Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ ÛŒÚ©â€ŒØ¨Ø§Ø± ÙˆØ±ÙˆØ¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø§Ø²ÛŒ Ø§Ø³Øª.</li>
                  <li><strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ù‚Ø¹ÛŒ:</strong> Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ù‚ÛŒÙ‚ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. ØªØ­ÙˆÛŒÙ„ Ø¬Ø§ÛŒØ²Ù‡ Ù…Ù†ÙˆØ· Ø¨Ù‡ ØªØ·Ø§Ø¨Ù‚ Ø¯Ù‚ÛŒÙ‚ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù‡ÙˆÛŒØª Ø´Ù…Ø§Ø³Øª.</li>
              </ul>

              <h3>Û². Ø±ÙˆÙ†Ø¯ Ú©Ù„ÛŒ Ø¨Ø§Ø²ÛŒ</h3>
              <ul>
                  <li>Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ø§Ø² <strong>Û· Ù…Ø±Ø­Ù„Ù‡ Ù…ØªÙˆØ§Ù„ÛŒ</strong> ØªØ´Ú©ÛŒÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
                  <li>Ø¨Ø§ Ø§Ù†Ø¬Ø§Ù… ØµØ­ÛŒØ­ Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ØŒ ØªÛŒÚ© Ø³Ø¨Ø² Ø±Ù†Ú¯ Ø¢Ù† Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
                  <li>Ø¨Ø±Ø§ÛŒ ØªØ¹Ø§Ù…Ù„ Ø¨Ø§ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø±ÙˆÛŒ Ù¾Ù†Ù„ØŒ ØªÙ†Ù‡Ø§ Ú©Ø§ÙÛŒØ³Øª Ø±ÙˆÛŒ Ø¢Ù†â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ (ÛŒØ§ Ù„Ù…Ø³ Ú©Ù†ÛŒØ¯).</li>
              </ul>

              <h3>Û³. Ù†Ù‚Ø´Ù‡ Ùˆ Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒ</h3>
              <ul>
                  <li>Ù†Ù‚Ø´Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø¯Ø§Ø± Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ø³Ù…Øª Ú†Ù¾ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ø²ÙˆÙ… Ø¯Ø§Ø±Ø¯.</li>
                  <li><strong>Ù‚Ø§Ù†ÙˆÙ† ÙØ±ÛŒØ² (Freeze Time):</strong> Ø¨Ø§ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡ØŒ ØªØ§ÛŒÙ…Ø± Ø¨Ø§Ø²ÛŒ Ø¨Ù‡ Ù…Ø¯Øª <strong>Û²Û° Ø«Ø§Ù†ÛŒÙ‡</strong> Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù¾Ø³ Ø§Ø² Ú¯Ø°Ø´Øª Û²Û° Ø«Ø§Ù†ÛŒÙ‡ØŒ ØªØ§ÛŒÙ…Ø± Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ù‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒØ§ÙØªØ¯.</li>
              </ul>

              <h3>Û´. Ù†Ú©Ø§Øª ÙÙ†ÛŒ Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒâ€ŒÙ‡Ø§</h3>
              <ul>
                  <li><strong>Ø§Ø®Ø·Ø§Ø±Ù‡Ø§:</strong> Ú©Ù„ÛŒÚ© Ø§Ø´ØªØ¨Ø§Ù‡ ÛŒØ§ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù†ÙˆØ¨Øª Ø¨Ø§Ø¹Ø« Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
                  <li><strong>ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø§ÙØ¸ (TS):</strong> Ù†Ù…Ø§ÛŒØ´Ú¯Ø± Ù…Ø­Ø§ÙØ¸ Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ© Ø§Ø³Øª Ùˆ Ø¨Ø§ÛŒØ¯ Ø¯Ø± ÛŒÚ© Ù…Ø±Ø­Ù„Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø¢Ù† ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯.</li>
                  <li><strong>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ù…Ù‡Ù…:</strong> Ø¯Ø± Ø¨Ø¹Ø¶ÛŒ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø§ÛŒØ¯ <strong>Ø¯Ùˆ Ú©Ù„ÛŒØ¯ Ø±Ø§ Ù‡Ù…Ø²Ù…Ø§Ù† ÙØ´Ø§Ø± Ø¨Ø¯ÛŒØ¯</strong> (ÙØ§ØµÙ„Ù‡ ÙØ´Ø±Ø¯Ù† Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û±.Ûµ Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø´Ø¯).</li>
              </ul>

              <h3>Ûµ. Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ</h3>
              <ul>
                  <li><strong>Ù¾ÛŒØ±ÙˆØ²ÛŒ:</strong> Ø¨Ø§ Ø§ØªÙ…Ø§Ù… Ø¨Ø§Ø²ÛŒ Ø¯Ø± Ø²Ù…Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ú†Ø±Ø§Øº Ù¾ÛŒØ±ÙˆØ²ÛŒ Ø³Ø¨Ø² Ø´Ø¯Ù‡ Ùˆ Ø¨Ø±Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯! <strong>Ø¯Ø± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø­ØªÙ…Ø§Ù‹ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯.</strong></li>
                  <li><strong>Ø´Ú©Ø³Øª:</strong> Ø¯Ø± ØµÙˆØ±Øª Ø§ØªÙ…Ø§Ù… Ø²Ù…Ø§Ù†ØŒ Ù¾ÛŒØ§Ù… Ø´Ú©Ø³Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              </ul>
          </div>
          <button id="agree-rules-btn">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù… Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù…</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù…Ø­Ø§ÙØ¸ -->
  <div class="modal" id="protectorModal">
    <div class="modal-backdrop" id="protBackdrop"></div>
    <div class="modal-box">
      <div class="protector-ui">
        <div class="protector-title">TS</div>
        <div class="protector-value" id="protectorValue">S300</div>
        <div class="protector-controls">
          <button id="protUp" class="ctrl">â–²</button>
          <button id="protSet" class="ctrl">SET</button>
          <button id="protDown" class="ctrl">â–¼</button>
        </div>
        <div class="prot-close" id="protClose">Ø¨Ø³ØªÙ†</div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù†Ù‚Ø´Ù‡ -->
  <div class="modal map-modal" id="mapModal">
    <div class="modal-backdrop" id="mapBackdrop"></div>
    <div class="modal-box map-box">
      <button class="map-close" id="mapCloseBtn">Ã—</button>
      <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¨Ø±Ø§ÛŒ Ø²ÙˆÙ… Ù†Ù‚Ø´Ù‡ -->
      <div id="mapZoomContainer" class="zoom-container">
         <img src="assets/map_large.jpg" alt="Ù†Ù‚Ø´Ù‡ Ø¨Ø²Ø±Ú¯ Ø¨Ø§Ø²ÛŒ" class="map-large" id="mapLarge" onerror="this.alt='Ø¹Ú©Ø³ Ù†Ù‚Ø´Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯'">
      </div>
    </div>
  </div>

  <script>
    /* =========================================
       1. Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù… ÙˆØ±ÙˆØ¯ + Ù‚ÙˆØ§Ù†ÛŒÙ†
       ========================================= */
    const loadingScreen = document.getElementById('loadingScreen');
    const loginOverlay = document.getElementById('loginOverlay');
    const gameViewport = document.getElementById('gameViewport');
    
    // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù‚ÙˆØ§Ù†ÛŒÙ†
    const rulesModal = document.getElementById('rules-modal');
    const agreeRulesBtn = document.getElementById('agree-rules-btn');
    
    // Ø³ÛŒØ³ØªÙ… Ø²ÙˆÙ…
    let fitGameToScreen; 

    window.addEventListener('load', () => {
      // Ø´Ø¨ÛŒÙ‡ Ø³Ø§Ø²ÛŒ Ù„ÙˆØ¯ÛŒÙ†Ú¯
      setTimeout(() => {
        loadingScreen.style.opacity = '0';
        setTimeout(() => {
          loadingScreen.style.display = 'none';
          loginOverlay.style.display = 'flex';
        }, 600);
      }, 1500); 
    });

    // 1. Ø³Ø§Ø¨Ù…ÛŒØª ÙØ±Ù… ÙˆØ±ÙˆØ¯ -> Ù†Ù…Ø§ÛŒØ´ Ù‚ÙˆØ§Ù†ÛŒÙ†
    const loginForm = document.getElementById('loginForm');
    let playerData = {};

    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const phoneVal = document.getElementById('phone').value.trim();
      const phoneError = document.getElementById('phoneError');
      
      // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø§Ø¯Ù‡ Ø´Ù…Ø§Ø±Ù‡
      if(!/^09[0-9]{9}$/.test(phoneVal)) {
        phoneError.style.display = 'block';
        return;
      }
      phoneError.style.display = 'none';

      playerData = { 
          firstName: document.getElementById('fname').value.trim(),
          lastName: document.getElementById('lname').value.trim()
      };

      // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ùˆ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ†
      loginOverlay.style.opacity = '0';
      setTimeout(() => {
        loginOverlay.style.display = 'none';
        rulesModal.classList.add('open'); // Ø¨Ø§Ø² Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ù‚ÙˆØ§Ù†ÛŒÙ†
      }, 500);
    });

    // 2. Ù¾Ø°ÛŒØ±Ø´ Ù‚ÙˆØ§Ù†ÛŒÙ† -> Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
    agreeRulesBtn.addEventListener('click', () => {
        rulesModal.classList.remove('open');
        
        // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ
        gameViewport.style.display = 'flex';
        
        // Ø§Ø¹Ù…Ø§Ù„ Ø²ÙˆÙ… Ùˆ ÙÛŒØª Ú©Ø±Ø¯Ù† Ø¨Ø±Ø¯ Ø¨Ù‡ ØµÙØ­Ù‡ Ø¯Ø± Ù„Ø­Ø¸Ù‡ Ù†Ù…Ø§ÛŒØ´
        setTimeout(() => {
            fitGameToScreen = applyPanZoom('gameZoomContainer', 'gamePanel', true);
            applyPanZoom('mapZoomContainer', 'mapLarge', false);
        }, 100);

        // Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø± Ø¨Ø§Ø²ÛŒ
        startGameTimer();
    });


    /* =========================================
       2. Ø³ÛŒØ³ØªÙ… ØµÙˆØªÛŒ
       ========================================= */
    const assets = { click: 'assets/click.mp3', error: 'assets/error.mp3' };
    function playSound(src, volume = 0.6){
      try {
        const a = new Audio(src);
        a.volume = volume;
        a.play().catch(()=>{});
      } catch(e){}
    }

    /* =========================================
       3. ÙˆØ¶Ø¹ÛŒØª Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
       ========================================= */
    const state = {
      stage: 0,
      gameTimerSec: 150, // 2.5 Ø¯Ù‚ÛŒÙ‚Ù‡
      protectorValue: 300,
      protectorActive: false,
      signals: { LED3: 'off', LED4: 'off', LED1: 'off' },
      selector: { S2: 'left', S3: 'left', S5: 'left' },
      pushes: {},
      joystick: 'neutral',
      fan: { blue: false, yellow: false },
      lastPressTimestamps: {},
      gameRunning: false,
      gameTimerInterval: null,
      
      // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙØ±ÛŒØ² Ù†Ù‚Ø´Ù‡
      isTimerPaused: false,
      mapFreezeTimeout: null
    };

    const $ = sel => document.querySelector(sel);
    const errorBadge = $('#errorBadge');
    const winLight = $('#winLight');
    const fanBladeBlue = $('#fanBladeBlue');
    const fanBladeYellow = $('#fanBladeYellow');

    /* ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ */
    function showError() { errorBadge.classList.add('show'); playSound(assets.error, 0.6); setTimeout(() => errorBadge.classList.remove('show'), 700); }
    function setStageDone(n) { const el = document.querySelector(`.stage[data-stage="${n}"]`); if(el) el.classList.add('done'); }
    function setLED(id, stateVal) {
      state.signals[id] = stateVal ? 'on' : 'off';
      const el = $('#' + id);
      if(el) el.dataset.state = stateVal ? 'on' : 'off';
    }
    function updateProtectorDisplayOnPanel() { $('#protectorDisplay').textContent = state.protectorValue; }
    
    function setFan(name, on) {
      if(name === 'blue') {
        state.fan.blue = on;
        if(on) { fanBladeBlue.style.opacity = '1'; fanBladeBlue.classList.add('rotate-medium'); } 
        else { fanBladeBlue.style.opacity = '0'; fanBladeBlue.classList.remove('rotate-medium'); }
      } else {
        state.fan.yellow = on;
        if(on) { fanBladeYellow.style.opacity = '1'; fanBladeYellow.classList.add('rotate-medium'); } 
        else { fanBladeYellow.style.opacity = '0'; fanBladeYellow.classList.remove('rotate-medium'); }
      }
    }

    /* =========================================
       4. ØªØ§ÛŒÙ…Ø± Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª ÙØ±ÛŒØ²
       ========================================= */
    function startGameTimer() {
      if(state.gameRunning) return;
      state.gameRunning = true;
      
      const tEl = $('#gameTimer');
      const updateTime = () => {
        const m = Math.floor(state.gameTimerSec / 60).toString().padStart(2, '0');
        const s = (state.gameTimerSec % 60).toString().padStart(2, '0');
        tEl.textContent = `${m}:${s}`;
        
        // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ Ù‡Ù†Ú¯Ø§Ù… ÙØ±ÛŒØ² ÛŒØ§ Ú©Ù… Ø¨ÙˆØ¯Ù† Ø²Ù…Ø§Ù†
        if (state.isTimerPaused) {
            tEl.style.color = '#2196f3'; // Ø¢Ø¨ÛŒ Ù‡Ù†Ú¯Ø§Ù… ÙØ±ÛŒØ²
        } else if (state.gameTimerSec <= 30) {
            tEl.style.color = '#ff3b3b'; // Ù‚Ø±Ù…Ø² Ù‡Ø´Ø¯Ø§Ø±
        } else {
            tEl.style.color = '#ffd166'; // Ø¹Ø§Ø¯ÛŒ
        }
      };
      updateTime();

      state.gameTimerInterval = setInterval(() => {
        // ÙÙ‚Ø· Ø§Ú¯Ø± ØªØ§ÛŒÙ…Ø± Ù…ØªÙˆÙ‚Ù Ù†Ø¨Ø§Ø´Ø¯ Ú©Ù… Ú©Ù†
        if (!state.isTimerPaused) {
            state.gameTimerSec--;
            updateTime();
            
            if(state.gameTimerSec <= 0) {
              clearInterval(state.gameTimerInterval); 
              state.gameRunning = false;
              showError(); 
              alert('Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯. Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ÛŒØ¯.'); 
              window.location.reload();
            }
        }
      }, 1000);
    }

    /* =========================================
       5. Ù…ÙˆØ¯Ø§Ù„ Ù†Ù‚Ø´Ù‡ Ùˆ Ù„Ø§Ø¬ÛŒÚ© ÙØ±ÛŒØ² Û²Û° Ø«Ø§Ù†ÛŒÙ‡
       ========================================= */
    const mapModal = $('#mapModal');

    function openMapLogic() {
        mapModal.classList.add('open');
        state.isTimerPaused = true; // ØªÙˆÙ‚Ù ØªØ§ÛŒÙ…Ø±
        $('#gameTimer').style.color = '#2196f3'; // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ Ù†Ø´Ø§Ù†Ú¯Ø± Ø¨Ù‡ Ø¢Ø¨ÛŒ
        
        // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ØªØ§ÛŒÙ…â€ŒØ§ÙˆØªÛŒ Ø¨ÙˆØ¯ Ù¾Ø§Ú© Ú©Ù†
        if(state.mapFreezeTimeout) clearTimeout(state.mapFreezeTimeout);
        
        // Ø¨Ø¹Ø¯ Ø§Ø² Û²Û° Ø«Ø§Ù†ÛŒÙ‡ØŒ ØªØ§ÛŒÙ…Ø± Ø§Ø¬Ø¨Ø§Ø±Ø§Ù‹ Ø±Ø§Ù‡ Ø¨ÛŒÙØªØ¯ Ø­ØªÛŒ Ø§Ú¯Ø± Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø§Ø³Øª
        state.mapFreezeTimeout = setTimeout(() => {
            state.isTimerPaused = false;
            $('#gameTimer').style.color = (state.gameTimerSec <= 30) ? '#ff3b3b' : '#ffd166';
        }, 20000); // 20 Ø«Ø§Ù†ÛŒÙ‡
    }

    function closeMapLogic() {
        mapModal.classList.remove('open');
        state.isTimerPaused = false; // Ø§Ø¯Ø§Ù…Ù‡ ÙÙˆØ±ÛŒ ØªØ§ÛŒÙ…Ø± Ø¨Ø§ Ø¨Ø³ØªÙ† Ù†Ù‚Ø´Ù‡
        if(state.mapFreezeTimeout) clearTimeout(state.mapFreezeTimeout);
         $('#gameTimer').style.color = (state.gameTimerSec <= 30) ? '#ff3b3b' : '#ffd166';
    }

    $('#mapSmall').addEventListener('click', openMapLogic);
    $('#mapCloseBtn').addEventListener('click', closeMapLogic);
    $('#mapBackdrop').addEventListener('click', closeMapLogic);

    /* =========================================
       6. Ù…ÙˆØ¯Ø§Ù„ Ù…Ø­Ø§ÙØ¸
       ========================================= */
    let protUpInterval, protDownInterval;
    function openProtectorModal() { $('#protectorModal').classList.add('open'); state.protectorActive = true; $('#protectorValue').textContent = 'S' + state.protectorValue; playSound(assets.click, 0.25); }
    function closeProtectorModal() { $('#protectorModal').classList.remove('open'); state.protectorActive = false; updateProtectorDisplayOnPanel(); }
    
    function updateProtectorModalDisplay() {
      const pValEl = $('#protectorValue');
      pValEl.textContent = 'S' + state.protectorValue;
      pValEl.classList.add('changing'); setTimeout(() => pValEl.classList.remove('changing'), 100);
    }
    function incrementProtector() { state.protectorValue++; if(state.protectorValue > 500) state.protectorValue = 1; updateProtectorModalDisplay(); }
    function decrementProtector() { state.protectorValue = Math.max(1, state.protectorValue - 1); updateProtectorModalDisplay(); }

    const protUp = $('#protUp'), protDown = $('#protDown');
    function startIncrement() { playSound(assets.click, 0.2); incrementProtector(); protUpInterval = setInterval(incrementProtector, 50); }
    function startDecrement() { playSound(assets.click, 0.2); decrementProtector(); protDownInterval = setInterval(decrementProtector, 50); }
    function stopIncrement() { clearInterval(protUpInterval); clearInterval(protDownInterval); }

    protUp.addEventListener('mousedown', startIncrement); protUp.addEventListener('touchstart', startIncrement);
    protUp.addEventListener('mouseup', stopIncrement); protUp.addEventListener('touchend', stopIncrement);
    protDown.addEventListener('mousedown', startDecrement); protDown.addEventListener('touchstart', startDecrement);
    protDown.addEventListener('mouseup', stopIncrement); protDown.addEventListener('touchend', stopIncrement);
    
    // ØªÚ© Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾
    protUp.addEventListener('click', incrementProtector); 
    protDown.addEventListener('click', decrementProtector);

    $('#protSet').addEventListener('click', () => {
      playSound(assets.click, 0.3);
      // Ø´Ø±Ø· Ù…Ø±Ø­Ù„Ù‡ 2: Ø§Ú¯Ø± Ù…Ø­Ø§ÙØ¸ Ø±ÙˆÛŒ 1 Ø³Øª Ø´ÙˆØ¯ Ùˆ Ú†Ø±Ø§Øº Ø²Ø±Ø¯ Ø±ÙˆØ´Ù† Ø¨Ø§Ø´Ø¯
      if(state.protectorValue === 1 && state.stage === 2 && state.signals.LED4 === 'on') {
        setTimeout(() => {
          setLED('LED4', false); setLED('LED1', true);
          state.stage = 3; setStageDone(3); closeProtectorModal();
        }, 500);
      } else { closeProtectorModal(); }
    });

    $('#protectorArea').addEventListener('click', openProtectorModal);
    $('#protClose').addEventListener('click', closeProtectorModal);
    $('#protBackdrop').addEventListener('click', closeProtectorModal);

    /* =========================================
       7. Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ù‡Ø§ Ø±ÙˆÛŒ Ø¨Ø±Ø¯
       ========================================= */
    $('#S0').addEventListener('click', () => {
      playSound(assets.click, 0.3);
      // Ø´Ø±ÙˆØ¹ Ù…Ø±Ø­Ù„Ù‡ 1 Ø¨Ø§ Ø²Ø¯Ù† S0
      if(state.stage === 0) { 
          state.stage = 1; 
          setLED('LED3', true); 
          setLED('LED1', false); 
          setStageDone(1); 
      }
    });

    ['S2','S3','S5'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('click', () => {
        playSound(assets.click, 0.2);
        const next = (el.dataset.pos === 'left') ? 'right' : 'left';
        el.dataset.pos = next; state.selector[id] = next;
        checkStageProgress('selector', id);
      });
    });

    $('#S9').addEventListener('click', () => {
      playSound(assets.click, 0.2);
      const el = $('#S9');
      el.dataset.pos = (el.dataset.pos === 'neutral') ? 'down' : 'neutral';
      state.joystick = el.dataset.pos; checkStageProgress('joystick', 'S9');
    });

    ['S1','S4_START','S4_STOP','S6_START','S6_STOP','S7','S8','S10'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('click', () => {
        playSound(assets.click, 0.2);
        el.setAttribute('aria-pressed', 'true');
        state.pushes[id] = true;
        state.lastPressTimestamps[id] = Date.now();
        setTimeout(() => { el.setAttribute('aria-pressed', 'false'); state.pushes[id] = false; }, 200);
        checkStageProgress('push', id);
      });
    });

    function isSimultaneous(idA, idB) { return Math.abs((state.lastPressTimestamps[idA] || 0) - (state.lastPressTimestamps[idB] || 0)) <= 1500; }
    function animateShake(el) { if(el) el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(-4px)'},{transform:'translateX(0)'}], {duration:360}); }

    /* =========================================
       8. Ù…Ù†Ø·Ù‚ Ø¬Ø§Ù…Ø¹ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø§Ø²ÛŒ
       ========================================= */
    function checkStageProgress(kind, id) {
      if(!state.gameRunning) return; // Ø§Ú¯Ø± Ø¨Ø§Ø²ÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡ØŒ ÙˆØ§Ú©Ù†Ø´ÛŒ Ù†Ø¯Ù‡

      // Stage 1 -> 2
      if(state.stage === 1) {
        if(kind === 'push' && id === 'S1') {
          // Ø´Ø±Ø·: Ø³Ù„Ú©ØªÙˆØ± S2 Ù†Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ Ú†Ù¾ Ø¨Ø§Ø´Ø¯
          if(state.selector.S2 && state.selector.S2 !== 'left') {
            setLED('LED4', true); setLED('LED3', false); setLED('LED1', false);
            state.stage = 2; setStageDone(2);
            state.protectorValue = 300; updateProtectorDisplayOnPanel();
          } else { showError(); animateShake(document.getElementById('S1')); }
        }
      }
      
      // Stage 3 -> 4
      else if(state.stage === 3) {
        if(kind === 'push' && (id === 'S6_START' || id === 'S7')) {
          if(isSimultaneous('S6_START','S7')) {
             setFan('blue', true); setStageDone(4); state.stage = 4;
          }
        }
      }

      // Stage 4 -> 5
      else if(state.stage === 4) {
        // Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† ÙÙ† Ø¢Ø¨ÛŒ Ø¨Ø§ S6 Stop Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯
        if(kind === 'push' && id === 'S6_STOP' && state.fan.blue) { 
            setFan('blue', false); 
        }
        // Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† ÙÙ† Ø²Ø±Ø¯ Ø¨Ø§ Ú©Ù„ÛŒØ¯ ØªØ±Ú©ÛŒØ¨ÛŒ
        if(kind === 'push' && (id === 'S4_START' || id === 'S8')) {
          if(isSimultaneous('S4_START','S8')) {
            if(!state.fan.blue) { // Ø´Ø±Ø·: ÙÙ† Ø¢Ø¨ÛŒ Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù…ÙˆØ´ Ø¨Ø§Ø´Ù‡
                setFan('yellow', true); setStageDone(5); state.stage = 5; 
            } else { showError(); }
          }
        }
      }

      // Stage 5 -> 6
      else if(state.stage === 5) {
        // Ø´Ø±Ø·: Ø³Ù„Ú©ØªÙˆØ±Ù‡Ø§ÛŒ S3 Ùˆ S5 Ú†Ø±Ø®Ø§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
        const selectorsRotated = state.selector.S3 !== 'left' && state.selector.S5 !== 'left';
        if(selectorsRotated && state.fan.yellow) {
          if(kind === 'push' && (id === 'S6_START' || id === 'S7')) {
            if(isSimultaneous('S6_START','S7')) {
              setFan('blue', true); setStageDone(6); state.stage = 6;
            }
          }
        }
      }

      // Stage 6 -> 7 (Ù¾Ø§ÛŒØ§Ù†)
      else if(state.stage === 6) {
        // Ø´Ø±Ø·: Ù‡Ø± Ø¯Ùˆ ÙÙ† Ø±ÙˆØ´Ù† Ø¨Ø§Ø´Ù†Ø¯
        if(state.fan.blue && state.fan.yellow) {
          if(kind === 'push' && id === 'S10') {
            if(state.joystick === 'down') {
              setStageDone(7); state.stage = 7;
              winLight.classList.add('on');
              clearInterval(state.gameTimerInterval);
              // Ù¾ÛŒØ§Ù… Ù¾ÛŒØ±ÙˆØ²ÛŒ
              setTimeout(() => alert(`ØªØ¨Ø±ÛŒÚ© ${playerData.firstName || ''} Ø¹Ø²ÛŒØ²! \nØ´Ù…Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯.\nÙ„Ø·ÙØ§ Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø§Ø² ØµÙØ­Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯.`), 500);
            } else { showError(); animateShake(document.getElementById('S10')); }
          }
        }
      }
    }

    /* =========================================
       9. Ø³ÛŒØ³ØªÙ… Pan & Zoom (Ø²ÙˆÙ… Ùˆ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ)
       ========================================= */
    function applyPanZoom(containerId, contentId, fitToScreen = false) {
        const container = document.getElementById(containerId);
        const content = document.getElementById(contentId);
        if (!container || !content) return;

        let scale = 1;
        let pointX = 0, pointY = 0;
        let startX = 0, startY = 0;
        let isDragging = false;

        // ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ø²ÙˆÙ… Ø¨Ø±Ø§ÛŒ ÙÛŒØª Ø´Ø¯Ù†
        function fitElement() {
            if (fitToScreen) {
                const rectContainer = container.getBoundingClientRect();
                const rectContent = content.getBoundingClientRect();
                
                // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØªØ±Ù†Ø³ÙØ±Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø§Ø¨Ø¹Ø§Ø¯ Ø§ØµÙ„ÛŒ
                content.style.transform = 'translate(0px, 0px) scale(1)';
                
                const baseWidth = 1808; // Ø¹Ø±Ø¶ Ø§ØµÙ„ÛŒ ØªØµÙˆÛŒØ± Ø¨Ø±Ø¯
                const baseHeight = 592; // Ø§Ø±ØªÙØ§Ø¹ Ø§ØµÙ„ÛŒ ØªØµÙˆÛŒØ± Ø¨Ø±Ø¯
                
                const scaleX = rectContainer.width / baseWidth;
                const scaleY = rectContainer.height / baseHeight;
                
                // Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³Ú©ÛŒÙ„ Ù…Ù†Ø§Ø³Ø¨ Ùˆ Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø­Ø§Ø´ÛŒÙ‡ Ø§Ù…Ù†
                scale = Math.min(scaleX, scaleY) * 0.95;
                
                // ÙˆØ³Ø· Ú†ÛŒÙ† Ú©Ø±Ø¯Ù†
                pointX = (rectContainer.width - baseWidth * scale) / 2;
                pointY = (rectContainer.height - baseHeight * scale) / 2;
                
                updateTransform();
            }
        }

        const updateTransform = () => {
            content.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        };

        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ³ ---
        container.addEventListener('mousedown', (e) => {
            e.preventDefault();
            isDragging = true;
            startX = e.clientX - pointX;
            startY = e.clientY - pointY;
            container.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            pointX = e.clientX - startX;
            pointY = e.clientY - startY;
            updateTransform();
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            container.style.cursor = 'grab';
        });

        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale;
            const ys = (e.clientY - pointY) / scale;
            const delta = -e.deltaY;
            
            const oldScale = scale;
            if (delta > 0) scale *= 1.1; else scale /= 1.1;
            
            // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²ÙˆÙ…
            scale = Math.min(Math.max(0.2, scale), 4);

            pointX = e.clientX - xs * scale;
            pointY = e.clientY - ys * scale;
            updateTransform();
        }, { passive: false });


        // --- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ØªØ§Ú† (Ù…ÙˆØ¨Ø§ÛŒÙ„) ---
        let initialPinchDistance = null;
        let initialScale = 1;

        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                isDragging = true;
                startX = e.touches[0].clientX - pointX;
                startY = e.touches[0].clientY - pointY;
            } else if (e.touches.length === 2) {
                isDragging = false;
                initialPinchDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                initialScale = scale;
            }
        }, { passive: false });

        container.addEventListener('touchmove', (e) => {
            if(e.cancelable) e.preventDefault();

            if (isDragging && e.touches.length === 1) {
                pointX = e.touches[0].clientX - startX;
                pointY = e.touches[0].clientY - startY;
                updateTransform();
            } else if (e.touches.length === 2 && initialPinchDistance) {
                const currentDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const zoomFactor = currentDistance / initialPinchDistance;
                scale = Math.min(Math.max(0.2, initialScale * zoomFactor), 4);
                updateTransform();
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            if (e.touches.length < 2) initialPinchDistance = null;
            if (e.touches.length === 0) isDragging = false;
            if (e.touches.length === 1) {
                // Ø³ÙˆÛŒÛŒÚ† Ù†Ø±Ù… Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¯Ø±Ú¯ Ø§Ú¯Ø± ÛŒÚ©ÛŒ Ø§Ø² Ø§Ù†Ú¯Ø´Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯
                isDragging = true;
                startX = e.touches[0].clientX - pointX;
                startY = e.touches[0].clientY - pointY;
            }
        });
        
        // Ø¨Ø§Ø²Ú¯Ø´Øª ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ù¾Ù†Ø¬Ø±Ù‡
        return fitElement;
    }
    
    // Ù„ÛŒØ³Ù†Ø± ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ù¾Ù†Ø¬Ø±Ù‡ Ø¨Ø±Ø§ÛŒ ÙÛŒØª Ø´Ø¯Ù† Ù…Ø¬Ø¯Ø¯
    window.addEventListener('resize', () => {
        if(typeof fitGameToScreen === 'function') fitGameToScreen();
    });

  </script>
</body>
</html>
