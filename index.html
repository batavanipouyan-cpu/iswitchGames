<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>بازی پنل - iswitch</title>
  <style>
    /* فونت ها */
    @font-face {
      font-family: 'Digital7';
      src: url('assets/digital-7.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --bg: #071025;
      --panel-w: 1808px;
      --panel-h: 592px;
      --led-size: 50px;
      --accent: #00ff9d;
      --error-color: #fa0536;
    }

    * {
      box-sizing: border-box;
      user-select: none; /* جلوگیری از انتخاب متن روی دکمه ها */
    }

    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: #051020;
      font-family: "Vazirmatn", "Tahoma", sans-serif;
      color: #e6eef6;
      overflow: hidden; /* جلوگیری از اسکرول کل صفحه */
    }

    /* --- فرم ورود --- */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #071025, #0a192f);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease;
    }
    
    .login-box {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      text-align: center;
    }

    .login-box h2 {
      margin-top: 0;
      color: var(--accent);
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 15px;
      text-align: right;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #a8c0d8;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.2);
      color: #fff;
      font-family: inherit;
      outline: none;
      transition: border-color 0.3s;
    }

    .input-group input:focus {
      border-color: var(--accent);
    }

    .start-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: #042018;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .start-btn:active {
      transform: scale(0.98);
    }

    .error-msg {
      color: #ffbbb7;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    /* --- محفظه اصلی بازی جهت اسکرول و زوم در موبایل --- */
    .game-viewport {
      width: 100vw;
      height: 100vh;
      overflow: auto; /* اسکرول آزاد برای رسیدن به همه جای پنل */
      display: flex;
      align-items: center; /* وسط چین کردن پنل در دسکتاپ */
      justify-content: center;
      padding: 20px;
      display: none; /* تا قبل از ورود مخفی است */
    }

    /* پنل اصلی */
    .panel-wrap {
      position: relative;
      width: var(--panel-w);
      height: var(--panel-h);
      flex-shrink: 0; /* جلوگیری از فشرده شدن در فلکس باکس */
    }

    /* عکس پس زمینه */
    .panel-bg {
      width: 100%;
      height: 100%;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    /* همه المان‌ها روی عکس */
    .mushroom, .push-btn, .selector, .joystick, .fan-wrap, 
    .led, .protector-area, .game-timer, .stages, 
    .map-small, .error-badge, .win-light {
      position: absolute;
      z-index: 2;
    }

    /* LED ها */
    .led {
      width: var(--led-size);
      height: var(--led-size);
      border-radius: 50%;
      box-shadow: 0 0 0 rgba(0,0,0,0.0);
      opacity: 0.35;
      transition: all .18s ease;
      pointer-events: none;
    }
    .led-red { 
        background: radial-gradient(circle at 30% 30%, #f72c2c, #ff0000);
        left: 1274px; top: 138px; z-index: 3;
    }
    .led-yellow { 
        background: radial-gradient(circle at 30% 30%, #ffd93d, #ff9f00);
        left:1274px; top: 45px; z-index: 2;
    }
    .led-green { 
        background: radial-gradient(circle at 30% 30%, #6bff6b, #00ff00);
        left: 1274px; top: 138px; z-index: 3;
    }
    .led[data-state="on"] { 
        opacity: 1; 
        filter: drop-shadow(0 0 15px currentColor) brightness(1.3);
    }

    /* پوش باتن ها */
    .push-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: #d9534f;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .06s ease;
      box-shadow: 0 8px 0 rgba(0,0,0,0.4);
    }
    #S1 {left: 1448px; top: 142px; background: #00000000; }
    #S4_START { left: 1056px; top: 186px; background: #00000000; }
    #S4_STOP { left: 1056px; top: 240px; background: #ef444400; }
    #S6_START { left: 1170px; top: 164px; background: #00000000; }
    #S6_STOP { left: 1170px; top: 240px; background: #00000000; }
    #S7 { left: 1626px;top: 357.3px; background: #00000000; }
    #S8 { left: 1626px;top: 238.3px; background: #00000000; }
    #S10 { left: 1626px;top: 140px;background: #39796400;}

    .push-btn[aria-pressed="true"] {
      transform: translateY(6px);
      box-shadow: 0 2px 0 rgba(0,0,0,0.6);
    }

    /* سلکتورها */
    .selector {
      width: 48px;
      height: 28px;
      border-radius: 6px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .08s ease;
    }
    .selector[data-pos="left"] { transform: rotate(310deg); }
    .selector[data-pos="right"] { transform: rotate(18deg); }
    #S2 { left: 1450px; top: 241.3px; }
    #S3 { left: 1274px; top: 244px; }
    #S5 { left: 1450px; top: 366px; }

    /* جوی استیک */
    .joystick {
      left: 1666px;
      top: 34px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #111827;
      border: none;
      color: #fff;
      cursor: pointer;
      transition: transform .12s ease;
    }
    .joystick[data-pos="down"] { transform: translateY(10px) rotate(6deg); }

    /* محافظ */
    .protector-area {
        left: 23.3%;
        top: 45.4%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 8px;
    }
    .protector-display {
      font-family: 'Digital7', monospace;
      font-size: 28px;
      color: #ff3b30;
      text-shadow: 0 0 10px rgba(255, 59, 48, 0.5);
    }

    /* فن ها */
    .fan-wrap {
      width: 175px;
      height: 175px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fan-base { 
      position: absolute; 
      width: 100%; 
      height: 100%; 
    }
    .fan-blade {
      position: absolute; 
      width: 70%;
      height: 70%;
      transform-origin: center center;
      transition: opacity .16s ease;
      opacity: 0;
    }
    #fanBlue { left: 52%; top: 59.7%; }
    #fanYellow { left: 66.1%; top: 59.7%; }
    .rotate-medium {
      animation: spin 0.7s linear infinite;
      opacity: 1;
    }
    @keyframes spin { 
      from { transform: rotate(0deg); } 
      to { transform: rotate(360deg); } 
    }

    /* دکمه قارچی */
    .mushroom {
      width: 50px;
      height: 50px;
      left: 1450px;
      top: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      border-radius: 26px;
    }

    /* تیک مراحل */
    .stages {
      right:70%;
      top: 5%;
      display: flex;
      gap: 8px;
    }
    .stage {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      background: rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #a8c0d8;
      font-size: 13px;
    }
    .stage.done { 
      background: linear-gradient(90deg, #34d399, #10b981); 
      color: #042018; 
      box-shadow: 0 6px 16px rgba(16,185,129,0.12); 
    }

    /* تایمر کلی بازی */
    .game-timer {
      left: 5%;
      top: 5%;
      background: rgba(0,0,0,0.6);
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'Digital7', monospace;
      font-size: 22px;
      color: #ffd166;
    }

    /* نقشه روی برد */
    .map-small {
      left: 5%;
      bottom: 5%;
      width: 80px;
      height: 60px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.1);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 12px;
    }
    .map-thumbnail { width: 100%; height: 100%; object-fit: cover; }

    /* خطای کوچک */
    .error-badge {
      right: 5%;
      bottom: 5%;
      background: var(--error-color);
      color: #fff;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      opacity: 0;
      transform: translateY(8px);
      transition: all .28s ease;
    }
    .error-badge.show { opacity: 1; transform: translateY(0); }

    /* چراغ برنده شدن */
    .win-light {
      left: 50%;
      top: 5%;
      width: 400px;
      height: 120px;
      border-radius: 8px;
      background: transparent;
      border: 3px solid rgba(255,255,255,0.1);
      transition: all .3s ease;
      transform: translateX(-50%);
    }
    .win-light.on { 
      border:3px solid #ffbbb7;
      box-shadow: 0 0 20px rgba(249,115,22,0.8), 0 0 40px rgba(249,115,22,0.4), inset 0 0 15px rgba(249,115,22,0.3);
      animation: pulse 1.5s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      from { box-shadow: 0 0 15px rgba(249,115,22,0.6), 0 0 30px rgba(249,115,22,0.3), inset 0 0 10px rgba(249,115,22,0.2); }
      to { box-shadow: 0 0 25px rgba(249,115,22,1), 0 0 50px rgba(249,115,22,0.6), inset 0 0 20px rgba(249,115,22,0.4); }
    }

    /* --- مودال های کلی (محافظ و نقشه) --- */
    .modal { 
      position: fixed; 
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 99999; 
    }
    .modal.open { display: flex; }
    .modal-backdrop { 
      position: absolute; 
      inset: 0; 
      background: rgba(0,0,0,0.7); 
    }
    .modal-box { 
      position: relative; 
      z-index: 100000; 
      background: #0b1220; 
      padding: 18px; 
      border-radius: 12px; 
      color: #fff; 
      box-shadow: 0 18px 50px rgba(0,0,0,0.6); 
      transform: scale(.8); 
      transition: transform .28s ease; 
    }
    .modal.open .modal-box { transform: scale(1); }

    /* استایل مودال محافظ */
    .protector-ui { display: flex; flex-direction: column; gap: 12px; align-items: center; min-width: 260px;}
    .protector-title { font-size: 20px; font-weight: 900; color: #9fd5ff; }
    .protector-value { 
      font-family: 'Digital7'; font-size: 38px; background: #000; padding: 6px 12px; 
      border-radius: 8px; color: #00ff80; transition: all 0.1s ease;
    }
    .protector-controls { display: flex; gap: 8px; }
    .ctrl { 
      padding: 10px 16px; border-radius: 8px; border: none; background: #111827; 
      color: #fff; cursor: pointer; font-weight: 700;
    }
    .ctrl:active { background: #1e40af; transform: scale(0.95); }
    .prot-close { cursor: pointer; color: #9fb1c9; font-size: 13px; margin-top:10px;}

    /* استایل مودال نقشه */
    .map-modal .modal-box {
      width: 95vw;
      height: 95vh;
      max-width: none;
      padding: 0;
      background: transparent;
      box-shadow: 0 25px 80px rgba(0,0,0,0.9);
      border: 3px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .map-large {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .map-close {
      position: absolute;
      top: 15px;
      right: 15px; /* تغییر به راست به دلیل rtl */
      background: rgba(255,0,50,0.8);
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      z-index: 100001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ریسپانسیو - اسکیلینگ ارتفاعی برای موبایل */
    @media (max-width: 900px) {
      .game-viewport {
        align-items: flex-start; /* در موبایل از بالا شروع شود */
        padding: 0;
      }
      .panel-wrap {
        /* پنل را بر اساس ارتفاع موبایل بزرگ میکنیم تا دکمه ها قابل لمس باشند */
        transform-origin: top left;
        transform: scale(calc(100vh / 650)); 
        margin: auto;
      }
    }
  </style>
</head>
<body>

  <!-- صفحه ورود اطلاعات -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>ثبت نام بازیکن</h2>
      <form id="loginForm">
        <div class="input-group">
          <label>نام</label>
          <input type="text" id="fname" required placeholder="نام خود را وارد کنید">
        </div>
        <div class="input-group">
          <label>نام خانوادگی</label>
          <input type="text" id="lname" required placeholder="نام خانوادگی را وارد کنید">
        </div>
        <div class="input-group">
          <label>شماره موبایل</label>
          <input type="tel" id="phone" required placeholder="09123456789" maxlength="11" dir="ltr">
          <div class="error-msg" id="phoneError">شماره موبایل باید ۱۱ رقم باشد و با ۰۹ شروع شود.</div>
        </div>
        <button type="submit" class="start-btn">ورود به بازی</button>
      </form>
    </div>
  </div>

  <!-- محیط اصلی بازی (اسکرول پذیر) -->
  <main class="game-viewport" id="gameViewport">
    <div class="panel-wrap">
      <img src="assets/BOARD.png" alt="پنل" class="panel-bg" id="panelBg">

      <!-- LED ها -->
      <div class="led led-red" id="LED3" data-state="off"></div>
      <div class="led led-yellow" id="LED4" data-state="off"></div>
      <div class="led led-green" id="LED1" data-state="off"></div>
      
      <!-- پوش باتن ها -->
      <button id="S0" class="mushroom">S0</button>
      <button class="push-btn" id="S1" aria-pressed="false">S1</button>
      <button class="push-btn" id="S4_START" aria-pressed="false">S4 Start</button>
      <button class="push-btn" id="S6_START" aria-pressed="false">S6 Start</button>
      <button class="push-btn" id="S4_STOP" aria-pressed="false">S4 Stop</button>
      <button class="push-btn" id="S6_STOP" aria-pressed="false">S6 Stop</button>
      <button class="push-btn" id="S7" aria-pressed="false">S7</button>
      <button class="push-btn" id="S8" aria-pressed="false">S8</button>
      <button class="push-btn" id="S10" aria-pressed="false">S10</button>

      <!-- سلکتورها -->
      <div class="selector" id="S2" data-pos="left">S2</div>
      <div class="selector" id="S3" data-pos="left">S3</div>
      <div class="selector" id="S5" data-pos="left">S5</div>

      <!-- جوی‌استیک -->
      <button class="joystick" id="S9" data-pos="neutral">S9</button>

      <!-- محافظ -->
      <div id="protectorArea" class="protector-area">
        <div class="protector-display" id="protectorDisplay">300</div>
      </div>

      <!-- فن ها -->
      <div class="fan-wrap" id="fanBlue">
        <div class="fan-base" style="background: radial-gradient(circle at 30% 30%, #3b82f6, #1e40af); border-radius: 50%;"></div>
        <div class="fan-blade" id="fanBladeBlue" style="background: conic-gradient(#60a5fa, #93c5fd, #60a5fa); border-radius: 50%;"></div>
      </div>

      <div class="fan-wrap" id="fanYellow">
        <div class="fan-base" style="background: radial-gradient(circle at 30% 30%, #f59e0b, #d97706); border-radius: 50%;"></div>
        <div class="fan-blade" id="fanBladeYellow" style="background: conic-gradient(#fbbf24, #fcd34d, #fbbf24); border-radius: 50%;"></div>
      </div>

      <!-- مراحل -->
      <div class="stages" id="stages">
        <div class="stage" data-stage="1">1</div>
        <div class="stage" data-stage="2">2</div>
        <div class="stage" data-stage="3">3</div>
        <div class="stage" data-stage="4">4</div>
        <div class="stage" data-stage="5">5</div>
        <div class="stage" data-stage="6">6</div>
        <div class="stage" data-stage="7">7</div>
      </div>

      <!-- تایمر و نقشه -->
      <div class="game-timer" id="gameTimer">02:30</div>
      <div id="mapSmallBtn" class="map-small">
        <img src="assets/map_small.png" alt="نقشه" class="map-thumbnail" onerror="this.style.display='none'; this.parentNode.innerHTML='نقشه';">
      </div>

      <!-- هشدار و چراغ پایان -->
      <div class="error-badge" id="errorBadge">✖</div>
      <div class="win-light" id="winLight"></div>
    </div>
  </main>

  <!-- مودال محافظ (مرتب و فیکس شده برای iOS) -->
  <div class="modal" id="protectorModal">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-box">
      <div class="protector-ui">
        <div class="protector-title">TS</div>
        <div class="protector-value" id="protectorValue">S300</div>
        <div class="protector-controls">
          <button id="protUp" class="ctrl">▲</button>
          <button id="protSet" class="ctrl">SET</button>
          <button id="protDown" class="ctrl">▼</button>
        </div>
        <div class="prot-close" id="protClose">بستن</div>
      </div>
    </div>
  </div>

  <!-- مودال نقشه بزرگ -->
  <div class="modal map-modal" id="mapModalFull">
    <div class="modal-backdrop" id="mapBackdropFull"></div>
    <div class="modal-box">
      <button class="map-close" id="mapCloseBtn">×</button>
      <img src="assets/map_large.jpg" alt="نقشه بزرگ" class="map-large" onerror="this.alt='عکس نقشه پیدا نشد'">
    </div>
  </div>

  <script>
    /* =========================================
       بخش مدیریت ورود و ثبت نام بازیکن
       ========================================= */
    const loginForm = document.getElementById('loginForm');
    const loginOverlay = document.getElementById('loginOverlay');
    const gameViewport = document.getElementById('gameViewport');
    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phoneError');

    // اطلاعات بازیکن برای ارسال به بک اند
    let playerData = {};

    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const phoneVal = phoneInput.value.trim();
      // بررسی شرط موبایل ایران
      const phoneRegex = /^09[0-9]{9}$/;
      
      if(!phoneRegex.test(phoneVal)) {
        phoneError.style.display = 'block';
        return;
      }
      
      phoneError.style.display = 'none';

      // ذخیره اطلاعات
      playerData = {
        firstName: document.getElementById('fname').value.trim(),
        lastName: document.getElementById('lname').value.trim(),
        phone: phoneVal
      };

      // اینجا می‌توانید اطلاعات را به سمت سرور خود ارسال کنید
      console.log("ورود بازیکن موفقیت آمیز بود:", playerData);

      // مخفی کردن فرم ورود و نمایش برد گیم
      loginOverlay.style.opacity = '0';
      setTimeout(() => {
        loginOverlay.style.display = 'none';
        gameViewport.style.display = 'flex';
        // هدایت کاربر به وسط تصویر در موبایل
        gameViewport.scrollLeft = 500; 
      }, 500);
    });

    /* =========================================
       بخش صداها و بازی (کدهای قبلی با اصلاحات جزئی)
       ========================================= */
    const assets = {
      click: 'assets/click.mp3',
      error: 'assets/error.mp3',
      fan: 'assets/fan_loop.mp3'
    };

    function playSound(src, volume = 0.6, loop = false){
      try {
        const a = new Audio(src);
        a.volume = volume;
        a.loop = loop;
        a.play().catch(()=>{});
        return a;
      } catch(e){}
    }

    const state = {
      stage: 0,
      gameTimerSec: 150,
      protectorValue: 300,
      protectorActive: false,
      signals: { LED3: 'off', LED4: 'off', LED1: 'off' },
      selector: { S2: 'left', S3: 'left', S5: 'left' },
      pushes: {},
      joystick: 'neutral',
      fan: { blue: false, yellow: false },
      lastPressTimestamps: {},
      gameRunning: false,
      gameTimerInterval: null
    };

    const $ = sel => document.querySelector(sel);
    const LED3 = $('#LED3'), LED4 = $('#LED4'), LED1 = $('#LED1');
    const errorBadge = $('#errorBadge');
    
    function updateProtectorDisplayOnPanel() {
      $('#protectorDisplay').textContent = state.protectorValue;
    }

    function showError() {
      errorBadge.classList.add('show');
      playSound(assets.error, 0.6);
      setTimeout(() => errorBadge.classList.remove('show'), 700);
    }

    function setStageDone(n) {
      const el = document.querySelector(`.stage[data-stage="${n}"]`);
      if(el) el.classList.add('done');
    }

    function setLED(id, stateVal) {
      state.signals[id] = stateVal ? 'on' : 'off';
      const el = (id === 'LED3')? LED3 : (id === 'LED4')? LED4 : LED1;
      el.dataset.state = stateVal ? 'on' : 'off';
    }

    function startGameTimer() {
      if(state.gameRunning) return;
      state.gameRunning = true;
      const tEl = $('#gameTimer');
      
      const updateTime = () => {
        const mm = String(Math.floor(state.gameTimerSec/60)).padStart(2,'0');
        const ss = String(state.gameTimerSec%60).padStart(2,'0');
        tEl.textContent = `${mm}:${ss}`;
      };
      
      updateTime();
      state.gameTimerInterval = setInterval(() => {
        state.gameTimerSec--;
        updateTime();
        if(state.gameTimerSec <= 0) {
          clearInterval(state.gameTimerInterval);
          state.gameRunning = false;
          showError();
          alert('زمان بازی به پایان رسید — شکست.');
          window.location.reload();
        }
      }, 1000);
    }

    /* === مودال نقشه اصلاح شده === */
    const mapSmallBtn = $('#mapSmallBtn');
    const mapModalFull = $('#mapModalFull');
    const mapCloseBtn = $('#mapCloseBtn');
    const mapBackdropFull = $('#mapBackdropFull');

    function openMap() {
      mapModalFull.classList.add('open');
    }
    function closeMap() {
      mapModalFull.classList.remove('open');
    }
    mapSmallBtn.addEventListener('click', openMap);
    mapCloseBtn.addEventListener('click', closeMap);
    mapBackdropFull.addEventListener('click', closeMap);


    /* === مودال محافظ اصلاح شده === */
    const protectorModal = $('#protectorModal');
    function openProtector() {
      protectorModal.classList.add('open');
      state.protectorActive = true;
      $('#protectorValue').textContent = 'S' + state.protectorValue;
    }
    function closeProtector() {
      protectorModal.classList.remove('open');
      state.protectorActive = false;
      updateProtectorDisplayOnPanel();
    }
    $('#protectorArea').addEventListener('click', openProtector);
    $('#protClose').addEventListener('click', closeProtector);
    $('#modalBackdrop').addEventListener('click', closeProtector);

    let pInt1, pInt2;
    function updatePVal(val) {
      state.protectorValue = val;
      if(state.protectorValue > 500) state.protectorValue = 1;
      if(state.protectorValue < 1) state.protectorValue = 1;
      $('#protectorValue').textContent = 'S' + state.protectorValue;
    }
    
    $('#protUp').addEventListener('mousedown', () => pInt1 = setInterval(()=>updatePVal(state.protectorValue+1),30));
    $('#protUp').addEventListener('mouseup', () => clearInterval(pInt1));
    $('#protUp').addEventListener('mouseleave', () => clearInterval(pInt1));
    $('#protUp').addEventListener('touchstart', () => pInt1 = setInterval(()=>updatePVal(state.protectorValue+1),30));
    $('#protUp').addEventListener('touchend', () => clearInterval(pInt1));
    $('#protUp').addEventListener('click', () => updatePVal(state.protectorValue+1));

    $('#protDown').addEventListener('mousedown', () => pInt2 = setInterval(()=>updatePVal(state.protectorValue-1),30));
    $('#protDown').addEventListener('mouseup', () => clearInterval(pInt2));
    $('#protDown').addEventListener('mouseleave', () => clearInterval(pInt2));
    $('#protDown').addEventListener('touchstart', () => pInt2 = setInterval(()=>updatePVal(state.protectorValue-1),30));
    $('#protDown').addEventListener('touchend', () => clearInterval(pInt2));
    $('#protDown').addEventListener('click', () => updatePVal(state.protectorValue-1));

    /* SET محافظ */
    $('#protSet').addEventListener('click', () => {
      playSound(assets.click, 0.3);
      if(state.protectorValue === 1 && state.stage === 2 && state.signals.LED4 === 'on') {
        setTimeout(() => {
          setLED('LED4', false);
          setLED('LED1', true);
          state.stage = 3;
          setStageDone(3);
          closeProtector();
        }, 1000);
      } else {
        closeProtector();
      }
    });

    /* دکمه ها و منطق بازی */
    $('#S0').addEventListener('click', () => {
      playSound(assets.click, 0.3);
      if(state.stage === 0) {
        state.stage = 1;
        setLED('LED3', true);
        setLED('LED1', false);
        setStageDone(1);
        startGameTimer();
      }
    });

    ['S2','S3','S5'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('click', () => {
        playSound(assets.click, 0.2);
        el.dataset.pos = (el.dataset.pos === 'left') ? 'right' : 'left';
        state.selector[id] = el.dataset.pos;
        checkLogic('selector', id);
      });
    });

    $('#S9').addEventListener('click', () => {
      playSound(assets.click, 0.2);
      const el = $('#S9');
      el.dataset.pos = (el.dataset.pos === 'neutral') ? 'down' : 'neutral';
      state.joystick = el.dataset.pos;
      checkLogic('joystick');
    });

    ['S1','S4_START','S4_STOP','S6_START','S6_STOP','S7','S8','S10'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('click', () => {
        playSound(assets.click, 0.2);
        el.setAttribute('aria-pressed', 'true');
        state.lastPressTimestamps[id] = Date.now();
        setTimeout(() => el.setAttribute('aria-pressed', 'false'), 200);
        checkLogic('push', id);
      });
    });

    function isSimul(a, b) { return Math.abs((state.lastPressTimestamps[a]||0) - (state.lastPressTimestamps[b]||0)) <= 1500; }
    
    function setFan(type, on) {
      state.fan[type] = on;
      const fb = type==='blue' ? $('#fanBladeBlue') : $('#fanBladeYellow');
      if(on){ fb.style.opacity='1'; fb.classList.add('rotate-medium'); playSound(assets.fan, 0.35, true); }
      else { fb.style.opacity='0'; fb.classList.remove('rotate-medium'); }
    }

    function checkLogic(k, id) {
      if(state.stage === 1 && k === 'push' && id === 'S1') {
        if(state.selector.S2 !== 'left') {
          setLED('LED4', true); setLED('LED3', false);
          state.stage = 2; setStageDone(2);
          updatePVal(300); updateProtectorDisplayOnPanel();
        } else { showError(); animateShake($('#S1')); }
      }
      
      if((state.stage===3||state.stage===4) && k==='push' && (id==='S6_START'||id==='S7')) {
        if(isSimul('S6_START','S7')){ setFan('blue', true); setStageDone(4); state.stage=4; }
      }

      if(state.stage>=4 && state.stage<6) {
        if(k==='push' && id==='S6_STOP' && state.fan.blue) setFan('blue', false);
        if(k==='push' && (id==='S4_START'||id==='S8')) {
          if(isSimul('S4_START','S8')) {
            if(!state.fan.blue) { setFan('yellow', true); setStageDone(5); state.stage=5; } else { showError(); }
          }
        }
      }

      if(state.stage === 5 && state.selector.S3!=='left' && state.selector.S5!=='left' && state.fan.yellow) {
        if(k==='push' && (id==='S6_START'||id==='S7') && isSimul('S6_START','S7')) {
          setFan('blue', true); setStageDone(6); state.stage=6;
        }
      }

      if(state.stage === 6 && state.fan.blue && state.fan.yellow && k==='push' && id==='S10') {
        if(state.joystick === 'down') {
          setStageDone(7); state.stage=7;
          $('#winLight').classList.add('on');
          clearInterval(state.gameTimerInterval);
          setTimeout(() => alert(`تبریک ${playerData.firstName}! بازی با موفقیت انجام شد.`), 500);
        } else { showError(); animateShake($('#S10')); }
      }
    }

    function animateShake(el) {
      if(el) el.animate([{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}], {duration:300});
    }

    updateProtectorDisplayOnPanel();
  </script>
</body>
</html>
